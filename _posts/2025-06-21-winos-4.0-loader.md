## Winos 4.0 Loader - sRDI Shellcode Analysis

Placeholder

Analysis starts with a NSIS installer binary called ToDesk_Setup_4.7.6.3.exe (86758fb6c5aa0093741402302a0478dab94992ff5c8426f2bc24c815cdeec08c).
This is a trojanised installer file which writes the legitimate application to: "C:\Program Files (x86)\Application", as well as a series of shellcode loaders and shellcode executors in "C:\Users\User\AppData\Local" and "C:\Users\User\AppData\Roaming\TrustAsia".

insttect.exe (ecd6742f5107215ed10fb7aebca3c35190e9a2a4022dc019f863abdcdd530fa9) - This is our first shellcode loader, which gets executed from the AppData\Local directory.

Setting a breakpoint at CreateFileA calls we can see that the binary creates a handle to Single.ini, which was written to the same directory.

![image](https://github.com/user-attachments/assets/82a5315e-653b-4291-b306-5e59c2db6e5d)

![image](https://github.com/user-attachments/assets/585ee1e7-8cd0-44ab-ba89-2cd090166349)

Following along until the next VirtualAlloc call, we can see in the ESI / EDI registers that there is a PE file in memory:

![image](https://github.com/user-attachments/assets/6dae1fd8-f9f4-4c5c-b944-0207e79a590e)

![image](https://github.com/user-attachments/assets/62629884-609f-4edf-83e0-70ba48635faa)

![image](https://github.com/user-attachments/assets/9ec325d5-9c80-4701-bdec-c6d88acdf6f4)

We could dump this executable from memory, alternatively, we can use a tool like Binary Refinery to carve the PE from the Single.ini file:

```
ef Single.ini | carve-pe | peek
```

![image](https://github.com/user-attachments/assets/a14519a6-99ee-4415-a072-3c0837c96ad5)

```
ef Single.ini | carve-pe | dump C:\Users\DFIR\Desktop\carved-dll.dll
```

Continuing with debugging we can see that the DLL is called with the VFPower export.

![image](https://github.com/user-attachments/assets/541eeb7a-56b8-45ff-a543-97f556ec3e4e)

Shortly after we notice the following mutex creation:

![image](https://github.com/user-attachments/assets/cbc0b715-ab6c-410c-9606-a9b7b2c0df62)


A reference to the CreateToolhelp32Snapshot API

![image](https://github.com/user-attachments/assets/44172ca6-9c1f-46ec-a1c3-90da6cee6423)

And there is a reference to 360Tray.exe

![image](https://github.com/user-attachments/assets/95574c05-a5ef-4f78-bf67-fb81bb21daa1)

Taking a look at IDA, there's the following function:

```
.text:100091CB loc_100091CB:                           ; CODE XREF: .text:10009163â†‘j
.text:100091CB                 mov     eax, off_10022D84
.text:100091D0                 movzx   eax, byte ptr [eax-758C082Ah]
.text:100091D7                 mov     ecx, off_10022B44
.text:100091DD                 add     ecx, edi
.text:100091DF                 xor     eax, 1
.text:100091E2                 push    eax
.text:100091E3                 push    offset dword_1001D176
.text:100091E8                 push    esi
.text:100091E9                 call    ecx
.text:100091EB                 add     esp, 0Ch
.text:100091EE                 mov     eax, off_10022B30
.text:100091F3                 add     eax, edi
.text:100091F5                 mov     ecx, esi
.text:100091F7                 lea     esi, [ebp-54h]
.text:100091FA                 push    esi
.text:100091FB                 call    eax
.text:100091FD                 mov     eax, off_10022B14
.text:10009202                 add     eax, edi
.text:10009204                 lea     ecx, [ebp-60h]
.text:10009207                 lea     edx, [ebp-3Ch]
.text:1000920A                 push    edx
.text:1000920B                 call    eax
.text:1000920D                 nop     dword ptr [eax]
```

dword_1001D176 is a list containing the following strings:

- 360Tray.exe
- 360LogCenter.exe
- 360Safe.exe
- 360speedld.exe
- LiveUpdate360.exe

The loader loops through the running processes by using CreateToolhelp32Snapshot and Process32Next, and for each process name it calls StrStrIW to check if it matches any of a hardcoded list of strings belonging to the 360 Security suite - a popular Chinese antivirus and system optimization product.
